/**
 * 
 */
package bm.notice.controller;

import java.io.File;
import java.io.IOException;
import java.text.SimpleDateFormat;
import java.util.Date;

import javax.servlet.http.HttpServletRequest;

import com.oreilly.servlet.MultipartRequest;
import com.oreilly.servlet.multipart.DefaultFileRenamePolicy;

import bm.member.model.vo.Member;
import bm.notice.model.service.NoticeService;
import bm.notice.model.vo.Notice;
import common.frontcontroller.Controller;
import common.frontcontroller.ModelAndView;

/**
 * @author user2
 *
 */
public class NoticeController implements Controller {

	NoticeService ns = new NoticeService();

	public ModelAndView noticeUpload(HttpServletRequest request) throws IOException {
		ModelAndView mav = new ModelAndView();
		Member member = (Member) request.getSession().getAttribute("loginInfo");
		//업로드할 파일의 용량제한  : 10MB
		int maxSize = 1024 * 1024 * 10;

		// 루트 절대 경로
		String root = request.getSession().getServletContext().getRealPath("/");

		// 파일 저장 경로
		String savePath = root + "resources/upload";

		String originFileName = "";

		String renameFileName = "";

		//request를 MultipartRequest로 교체
		//MultipartRequest 객체가 생성됨과 동시에 파일 업로드가 이루어 진다.
		MultipartRequest mrequest = new MultipartRequest(request, savePath, maxSize, "UTF-8",
				new DefaultFileRenamePolicy());

		originFileName = mrequest.getFilesystemName("noticeFile");
		if (originFileName != null) {
			String fileName = String.valueOf(new Date().getTime());
			renameFileName = fileName + originFileName.substring(originFileName.lastIndexOf("."));

			File originFile = new File(savePath + "\\" + originFileName);
			File renameFile = new File(savePath + "\\" + renameFileName);

			originFile.renameTo(renameFile);
		}

		String title = mrequest.getParameter("noticeTitle");
		String content = mrequest.getParameter("noticeContent");
		String writer = member.getM_id();

		Notice notice = new Notice();
		notice.setNoticeTitle(title);
		notice.setNoticeContent(content);
		notice.setNoticeWriter(writer);
		notice.setOriginal_filepath(originFileName);
		notice.setRename_filepath(renameFileName);

		int res = ns.noticeUpload(notice);

		if (res >= 1) {
			System.out.println("게시물 등록 성공");
			mav.setView("board/boardForm");

		} else {
			mav.addObject("alertMsg", "게시물 등록이 실패하였습니다.");
			mav.addObject("url", "/servletBM/notice/notice.do");
			mav.setView("common/result");

		}
		return mav;
	}

	public ModelAndView notice(HttpServletRequest request) {
		ModelAndView mav = new ModelAndView();

		mav.setView("board/boardForm");
		return mav;
	}
}
